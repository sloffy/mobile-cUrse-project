/**
 * Утилиты для анализа текста
 * Все функции работают локально, без внешних сервисов
 */

// Стоп-слова русского языка (часто встречающиеся слова, не несущие смысловой нагрузки)
const STOP_WORDS = new Set([
  'и', 'в', 'не', 'что', 'он', 'на', 'я', 'со', 'как', 'а', 'то', 'все', 'она', 'так', 'его',
  'но', 'да', 'ты', 'к', 'у', 'же', 'вы', 'за', 'бы', 'по', 'только', 'ее', 'мне', 'было',
  'вот', 'от', 'меня', 'еще', 'нет', 'о', 'из', 'ему', 'теперь', 'когда', 'даже', 'ну', 'вдруг',
  'ли', 'если', 'уже', 'или', 'быть', 'был', 'него', 'до', 'вас', 'ни', 'была', 'под', 'вами',
  'уж', 'затем', 'это', 'эти', 'этого', 'этой', 'этом', 'эту', 'этим', 'этих', 'этими', 'этими',
  'этот', 'эта', 'это', 'эти', 'этот', 'эта', 'это', 'эти', 'этот', 'эта', 'это', 'эти',
  'который', 'которая', 'которое', 'которые', 'которого', 'которой', 'которому', 'которым',
  'которую', 'которыми', 'которых', 'которыми', 'которых', 'которыми',
  'какой', 'какая', 'какое', 'какие', 'какого', 'какой', 'какому', 'каким',
  'какую', 'какими', 'каких', 'какими', 'каких', 'какими',
  'свой', 'своя', 'свое', 'свои', 'своего', 'своей', 'своему', 'своим',
  'свою', 'своими', 'своих', 'своими', 'своих', 'своими',
  'мой', 'моя', 'мое', 'мои', 'моего', 'моей', 'моему', 'моим',
  'мою', 'моими', 'моих', 'моими', 'моих', 'моими',
  'твой', 'твоя', 'твое', 'твои', 'твоего', 'твоей', 'твоему', 'твоим',
  'твою', 'твоими', 'твоих', 'твоими', 'твоих', 'твоими',
  'наш', 'наша', 'наше', 'наши', 'нашего', 'нашей', 'нашему', 'нашим',
  'нашу', 'нашими', 'наших', 'нашими', 'наших', 'нашими',
  'ваш', 'ваша', 'ваше', 'ваши', 'вашего', 'вашей', 'вашему', 'вашим',
  'вашу', 'вашими', 'ваших', 'вашими', 'ваших', 'вашими',
  'их', 'его', 'ее', 'их', 'его', 'ее', 'их', 'его', 'ее', 'их',
  'себя', 'себе', 'собой', 'себя', 'себе', 'собой',
  'кто', 'что', 'какой', 'какая', 'какое', 'какие', 'чей', 'чья', 'чье', 'чьи',
  'где', 'куда', 'откуда', 'когда', 'как', 'почему', 'зачем', 'отчего',
  'этот', 'эта', 'это', 'эти', 'тот', 'та', 'то', 'те',
  'весь', 'вся', 'все', 'все', 'всего', 'всей', 'всему', 'всем',
  'всю', 'всеми', 'всех', 'всеми', 'всех', 'всеми',
  'сам', 'сама', 'само', 'сами', 'самого', 'самой', 'самому', 'самим',
  'саму', 'самими', 'самих', 'самими', 'самих', 'самими',
  'другой', 'другая', 'другое', 'другие', 'другого', 'другой', 'другому', 'другим',
  'другую', 'другими', 'других', 'другими', 'других', 'другими',
  'каждый', 'каждая', 'каждое', 'каждые', 'каждого', 'каждой', 'каждому', 'каждым',
  'каждую', 'каждыми', 'каждых', 'каждыми', 'каждых', 'каждыми',
  'любой', 'любая', 'любое', 'любые', 'любого', 'любой', 'любому', 'любым',
  'любую', 'любыми', 'любых', 'любыми', 'любых', 'любыми',
  'весь', 'вся', 'все', 'все', 'всего', 'всей', 'всему', 'всем',
  'всю', 'всеми', 'всех', 'всеми', 'всех', 'всеми',
]);

/**
 * Предобработка текста: приведение к нижнему регистру, удаление пунктуации
 */
export function preprocessText(text) {
  if (!text || typeof text !== 'string') return '';
  
  // Приведение к нижнему регистру
  let processed = text.toLowerCase();
  
  // Удаление пунктуации (оставляем только буквы, цифры и пробелы)
  processed = processed.replace(/[^\p{L}\p{N}\s]/gu, ' ');
  
  // Удаление множественных пробелов
  processed = processed.replace(/\s+/g, ' ').trim();
  
  return processed;
}

/**
 * Токенизация: разбиение текста на слова
 */
export function tokenize(text) {
  const processed = preprocessText(text);
  return processed.split(/\s+/).filter(word => word.length > 0);
}

/**
 * Удаление стоп-слов из массива токенов
 */
export function removeStopWords(tokens) {
  return tokens.filter(token => !STOP_WORDS.has(token) && token.length > 1);
}

/**
 * Частотный анализ: подсчет частоты слов
 * @returns {Array<{word: string, frequency: number}>} Массив объектов с словом и частотой
 */
export function frequencyAnalysis(text) {
  const tokens = tokenize(text);
  const filteredTokens = removeStopWords(tokens);
  
  // Подсчет частоты
  const frequencyMap = {};
  filteredTokens.forEach(word => {
    frequencyMap[word] = (frequencyMap[word] || 0) + 1;
  });
  
  // Преобразование в массив и сортировка по убыванию частоты
  const frequencyArray = Object.entries(frequencyMap).map(([word, frequency]) => ({
    word,
    frequency,
  }));
  
  frequencyArray.sort((a, b) => b.frequency - a.frequency);
  
  return frequencyArray;
}

/**
 * Поиск словосочетаний (биграмм и триграмм) с учетом частей речи
 * Отбираем последовательности существительных и прилагательных
 */
export function findPhrases(text, minLength = 2, maxLength = 3) {
  const tokens = tokenize(text);
  const filteredTokens = removeStopWords(tokens);
  
  const phrases = {};
  
  // Генерация биграмм и триграмм с фильтрацией по частям речи
  for (let i = 0; i < filteredTokens.length - 1; i++) {
    const word1 = filteredTokens[i];
    const word2 = filteredTokens[i + 1];
    
    // Биграммы: существительное + существительное или прилагательное + существительное
    if (minLength <= 2 && maxLength >= 2) {
      // Проверяем, что хотя бы одно слово - существительное
      if (isNoun(word1) || isNoun(word2)) {
        const bigram = `${word1} ${word2}`;
        phrases[bigram] = (phrases[bigram] || 0) + 1;
      }
    }
    
    // Триграммы: комбинации существительных и прилагательных
    if (minLength <= 3 && maxLength >= 3 && i < filteredTokens.length - 2) {
      const word3 = filteredTokens[i + 2];
      // Проверяем, что хотя бы одно слово - существительное
      if (isNoun(word1) || isNoun(word2) || isNoun(word3)) {
        const trigram = `${word1} ${word2} ${word3}`;
        phrases[trigram] = (phrases[trigram] || 0) + 1;
      }
    }
  }
  
  // Преобразование в массив и сортировка
  const phrasesArray = Object.entries(phrases)
    .filter(([_, frequency]) => frequency >= 2) // Минимум 2 вхождения
    .map(([phrase, frequency]) => ({
      phrase,
      frequency,
    }))
    .sort((a, b) => b.frequency - a.frequency);
  
  return phrasesArray;
}

/**
 * Комбинированный поиск терминов
 * Использует частотный анализ, фильтрацию по частям речи и поиск аббревиатур
 */
export function findTerms(text) {
  const terms = [];
  
  // 1. Частотный анализ с лемматизацией
  const tokens = tokenize(text);
  const filteredTokens = removeStopWords(tokens);
  
  // Подсчет частоты с учетом лемматизации
  const frequencyMap = {};
  const wordForms = {}; // Храним все формы слова для отображения
  
  filteredTokens.forEach(word => {
    const lemma = lemmatize(word);
    frequencyMap[lemma] = (frequencyMap[lemma] || 0) + 1;
    
    // Сохраняем исходную форму, если она длиннее или встречается чаще
    if (!wordForms[lemma] || word.length > wordForms[lemma].length) {
      wordForms[lemma] = word;
    }
  });
  
  // Фильтруем по существительным и берем топ-50
  const nounFrequency = Object.entries(frequencyMap)
    .filter(([word]) => isNoun(word))
    .map(([lemma, frequency]) => ({
      word: wordForms[lemma] || lemma,
      lemma,
      frequency,
    }))
    .sort((a, b) => b.frequency - a.frequency)
    .slice(0, 50);
  
  nounFrequency.forEach(item => {
    terms.push({
      term: item.word,
      type: 'word',
      frequency: item.frequency,
    });
  });
  
  // 2. Словосочетания (биграммы и триграммы) с фильтрацией по частям речи
  const phrases = findPhrases(text, 2, 3);
  const topPhrases = phrases.slice(0, 30);
  
  topPhrases.forEach(item => {
    terms.push({
      term: item.phrase,
      type: 'phrase',
      frequency: item.frequency,
    });
  });
  
  // 3. Аббревиатуры с расшифровкой
  const abbreviations = findAbbreviations(text);
  abbreviations.forEach(item => {
    terms.push({
      term: item.abbreviation,
      type: 'abbreviation',
      frequency: 1,
      expansion: item.expansion,
    });
  });
  
  // Убираем дубликаты и сортируем по частоте
  const uniqueTerms = [];
  const seen = new Set();
  
  terms.forEach(term => {
    const key = term.term.toLowerCase();
    if (!seen.has(key)) {
      seen.add(key);
      uniqueTerms.push(term);
    }
  });
  
  // Сортируем по частоте (убывание)
  uniqueTerms.sort((a, b) => (b.frequency || 0) - (a.frequency || 0));
  
  // Возвращаем минимум 100 терминов
  return uniqueTerms.slice(0, Math.max(100, uniqueTerms.length));
}

/**
 * Список известных существительных (базовые формы)
 * Используется для фильтрации терминов по части речи
 */
const NOUNS = new Set([
  // Информатика
  'данные', 'данный', 'система', 'программа', 'алгоритм', 'код', 'файл', 'база', 'сервер',
  'клиент', 'интерфейс', 'модуль', 'компонент', 'функция', 'метод', 'класс', 'объект',
  'процесс', 'операция', 'запрос', 'ответ', 'результат', 'значение', 'переменная', 'массив',
  'структура', 'формат', 'тип', 'версия', 'релиз', 'обновление', 'установка', 'конфигурация',
  'настройка', 'параметр', 'опция', 'режим', 'состояние', 'событие', 'ошибка', 'исключение',
  'логирование', 'отладка', 'тестирование', 'разработка', 'проект', 'репозиторий', 'коммит',
  'ветка', 'слияние', 'деплой', 'развертывание', 'контейнер', 'образ', 'микросервис',
  'архитектура', 'паттерн', 'фреймворк', 'библиотека', 'зависимость', 'пакет', 'модуль',
  'плагин', 'расширение', 'инструмент', 'утилита', 'скрипт', 'команда', 'выполнение',
  'обработка', 'трансформация', 'конвертация', 'валидация', 'авторизация', 'аутентификация',
  'сессия', 'токен', 'ключ', 'шифрование', 'безопасность', 'защита', 'доступ', 'право',
  'роль', 'пользователь', 'администратор', 'разработчик', 'программист', 'тестировщик',
  'аналитик', 'дизайнер', 'менеджер', 'команда', 'компания', 'организация', 'проект',
  'задача', 'требование', 'спецификация', 'документация', 'руководство', 'инструкция',
  'пример', 'демонстрация', 'презентация', 'конференция', 'митап', 'воркшоп', 'тренинг',
  'курс', 'обучение', 'знание', 'навык', 'опыт', 'практика', 'теория', 'концепция',
  'идея', 'решение', 'подход', 'методология', 'стандарт', 'протокол', 'формат', 'схема',
  'модель', 'представление', 'отображение', 'визуализация', 'график', 'диаграмма', 'таблица',
  'список', 'массив', 'коллекция', 'набор', 'группа', 'категория', 'класс', 'тип',
  'вид', 'разновидность', 'вариант', 'версия', 'релиз', 'сборка', 'билд', 'деплой',
  'развертывание', 'конфигурация', 'настройка', 'параметр', 'опция', 'режим', 'состояние',
  'событие', 'действие', 'операция', 'функция', 'метод', 'процедура', 'алгоритм', 'логика',
  'условие', 'цикл', 'итерация', 'рекурсия', 'вызов', 'возврат', 'результат', 'значение',
  'переменная', 'константа', 'массив', 'список', 'словарь', 'множество', 'очередь', 'стек',
  'дерево', 'граф', 'узел', 'ребро', 'вершина', 'путь', 'маршрут', 'алгоритм', 'поиск',
  'сортировка', 'фильтрация', 'группировка', 'агрегация', 'суммирование', 'подсчет', 'статистика',
  'анализ', 'обработка', 'трансформация', 'конвертация', 'валидация', 'проверка', 'тестирование',
  'отладка', 'логирование', 'мониторинг', 'отслеживание', 'профилирование', 'оптимизация',
  'улучшение', 'рефакторинг', 'модернизация', 'обновление', 'миграция', 'интеграция',
  'взаимодействие', 'коммуникация', 'обмен', 'передача', 'получение', 'отправка', 'загрузка',
  'выгрузка', 'экспорт', 'импорт', 'синхронизация', 'кэширование', 'хранение', 'сохранение',
  'загрузка', 'выгрузка', 'чтение', 'запись', 'удаление', 'создание', 'обновление', 'изменение',
  'модификация', 'редактирование', 'форматирование', 'стилизация', 'оформление', 'дизайн',
  'интерфейс', 'компонент', 'элемент', 'виджет', 'контрол', 'кнопка', 'поле', 'форма',
  'страница', 'экран', 'окно', 'диалог', 'модальное', 'всплывающее', 'меню', 'список',
  'таблица', 'график', 'диаграмма', 'изображение', 'иконка', 'логотип', 'баннер', 'заголовок',
  'подзаголовок', 'текст', 'параграф', 'абзац', 'строка', 'символ', 'буква', 'цифра',
  'число', 'дата', 'время', 'период', 'интервал', 'длительность', 'таймаут', 'задержка',
  'пауза', 'ожидание', 'обработка', 'выполнение', 'запуск', 'остановка', 'завершение',
  'прерывание', 'отмена', 'откат', 'возврат', 'восстановление', 'резервное', 'копирование',
  'бэкап', 'архивирование', 'сжатие', 'распаковка', 'установка', 'удаление', 'обновление',
  'настройка', 'конфигурация', 'параметр', 'опция', 'режим', 'состояние', 'событие', 'действие',
  'операция', 'функция', 'метод', 'процедура', 'алгоритм', 'логика', 'условие', 'цикл',
  'итерация', 'рекурсия', 'вызов', 'возврат', 'результат', 'значение', 'переменная', 'константа',
  // Лингвистика
  'слово', 'фраза', 'предложение', 'текст', 'документ', 'статья', 'книга', 'публикация',
  'исследование', 'анализ', 'изучение', 'рассмотрение', 'рассмотрение', 'обсуждение',
  'дискуссия', 'полемика', 'спор', 'аргумент', 'доказательство', 'обоснование', 'тезис',
  'гипотеза', 'теория', 'концепция', 'идея', 'мысль', 'суждение', 'мнение', 'точка',
  'зрения', 'позиция', 'подход', 'метод', 'методика', 'способ', 'прием', 'техника',
  'стратегия', 'тактика', 'план', 'схема', 'структура', 'организация', 'система', 'классификация',
  'категоризация', 'группировка', 'типология', 'таксономия', 'иерархия', 'уровень', 'ступень',
  'этап', 'фаза', 'стадия', 'период', 'эпоха', 'время', 'момент', 'миг', 'секунда', 'минута',
  'час', 'день', 'неделя', 'месяц', 'год', 'век', 'тысячелетие', 'эра', 'эпоха', 'период',
  // Медицина
  'заболевание', 'болезнь', 'симптом', 'признак', 'проявление', 'клиника', 'диагноз',
  'диагностика', 'обследование', 'исследование', 'анализ', 'тест', 'проба', 'образец',
  'материал', 'биоматериал', 'кровь', 'моча', 'кал', 'мокрота', 'мазок', 'биопсия',
  'гистология', 'цитология', 'микробиология', 'бактериология', 'вирусология', 'паразитология',
  'иммунология', 'аллергология', 'эндокринология', 'кардиология', 'пульмонология', 'гастроэнтерология',
  'гепатология', 'нефрология', 'урология', 'гинекология', 'акушерство', 'педиатрия', 'геронтология',
  'онкология', 'гематология', 'ревматология', 'дерматология', 'венерология', 'неврология',
  'психиатрия', 'психология', 'офтальмология', 'оториноларингология', 'стоматология',
  'ортопедия', 'травматология', 'хирургия', 'анестезиология', 'реаниматология', 'интенсивная',
  'терапия', 'лечение', 'медикаментозное', 'хирургическое', 'физиотерапевтическое', 'реабилитация',
  'профилактика', 'вакцинация', 'иммунизация', 'скрининг', 'диспансеризация', 'наблюдение',
  'мониторинг', 'контроль', 'проверка', 'осмотр', 'консультация', 'прием', 'визит', 'обращение',
  'госпитализация', 'стационар', 'амбулатория', 'поликлиника', 'больница', 'клиника', 'центр',
  'институт', 'лаборатория', 'кабинет', 'палата', 'отделение', 'блок', 'операционная', 'перевязочная',
  'процедурная', 'кабинет', 'зал', 'коридор', 'вестибюль', 'регистратура', 'аптека', 'склад',
  'хранилище', 'архив', 'база', 'данных', 'информация', 'документ', 'история', 'болезни',
  'медицинская', 'карта', 'амбулаторная', 'стационарная', 'выписка', 'справка', 'заключение',
  'результат', 'анализа', 'исследования', 'протокол', 'операции', 'аутопсии', 'вскрытия',
  'патологоанатомическое', 'заключение', 'эпикриз', 'диагноз', 'клинический', 'патологоанатомический',
  'нозологическая', 'форма', 'стадия', 'степень', 'тяжесть', 'течение', 'острое', 'хроническое',
  'подострое', 'ремиссия', 'обострение', 'рецидив', 'осложнение', 'сопутствующее', 'заболевание',
  'фоновое', 'предраковое', 'злокачественное', 'доброкачественное', 'новообразование', 'опухоль',
  'рак', 'карцинома', 'саркома', 'лимфома', 'лейкоз', 'лейкемия', 'миелома', 'меланома',
]);

/**
 * Упрощенная лемматизация: приведение слова к базовой форме
 * Удаляет типичные окончания для получения основы слова
 */
function lemmatize(word) {
  if (!word || word.length < 3) return word;
  
  const lower = word.toLowerCase();
  
  // Типичные окончания существительных (упрощенная версия)
  const endings = [
    // Родительный падеж
    /(а|я|и|ы|е|о|у|ю)$/,
    // Дательный падеж
    /(у|ю|е|и)$/,
    // Винительный падеж
    /(у|ю|а|я|о|е)$/,
    // Творительный падеж
    /(ом|ем|ой|ей|ами|ями)$/,
    // Предложный падеж
    /(е|и|ах|ях)$/,
  ];
  
  // Пробуем удалить окончания
  for (const ending of endings) {
    const withoutEnding = lower.replace(ending, '');
    if (withoutEnding.length >= 3 && NOUNS.has(withoutEnding)) {
      return withoutEnding;
    }
  }
  
  // Если не нашли, возвращаем исходное слово
  return lower;
}

/**
 * Проверка, является ли слово существительным
 */
function isNoun(word) {
  const lower = word.toLowerCase();
  const lemma = lemmatize(lower);
  return NOUNS.has(lower) || NOUNS.has(lemma);
}

/**
 * Улучшенный поиск аббревиатур с расшифровкой в скобках
 * Пример: NLP (Natural Language Processing)
 */
export function findAbbreviations(text) {
  const abbreviations = [];
  
  // Паттерн для поиска аббревиатур с расшифровкой: АББР (расшифровка)
  const withExpansionPattern = /\b([А-ЯЁA-Z0-9]{2,})\s*\(([^)]+)\)/g;
  let match;
  
  while ((match = withExpansionPattern.exec(text)) !== null) {
    abbreviations.push({
      abbreviation: match[1],
      expansion: match[2].trim(),
      original: `${match[1]} (${match[2].trim()})`,
    });
  }
  
  // Также ищем аббревиатуры без расшифровки
  const abbreviationPattern = /\b[А-ЯЁA-Z0-9]{2,}\b/g;
  const matches = text.match(abbreviationPattern) || [];
  const unique = [...new Set(matches)];
  
  // Добавляем аббревиатуры, которые еще не были найдены с расшифровкой
  const foundAbbrs = new Set(abbreviations.map(a => a.abbreviation));
  unique.forEach(abbr => {
    if (!foundAbbrs.has(abbr)) {
      abbreviations.push({
        abbreviation: abbr,
        expansion: null,
        original: abbr,
      });
    }
  });
  
  return abbreviations;
}

/**
 * Поиск имен собственных (упрощенный алгоритм)
 * Ищем слова с заглавной буквы, которые не в начале предложения
 */
export function findProperNouns(text) {
  // Разбиваем на предложения
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  
  const properNouns = new Set();
  
  sentences.forEach(sentence => {
    const words = sentence.trim().split(/\s+/);
    
    // Пропускаем первое слово (оно может быть с заглавной буквы по правилам)
    for (let i = 1; i < words.length; i++) {
      const word = words[i].replace(/[^\p{L}]/gu, '');
      
      // Если слово начинается с заглавной буквы и содержит только буквы
      if (word.length > 1 && /^[А-ЯЁ]/.test(word) && /^[А-ЯЁа-яё]+$/.test(word)) {
        properNouns.add(word);
      }
    }
  });
  
  return Array.from(properNouns).map(noun => ({
    name: noun,
    category: 'unknown', // Будет определяться пользователем или дополнительной логикой
  }));
}

/**
 * Поиск контекстов для термина
 * @param {string} text - Исходный текст
 * @param {string} term - Термин для поиска
 * @param {number} maxContexts - Максимальное количество контекстов
 * @returns {Array<{context: string, source: string}>} Массив контекстов
 */
export function findContexts(text, term, maxContexts = 5) {
  const contexts = [];
  const termLower = term.toLowerCase();
  
  // Разбиваем текст на предложения
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  
  for (const sentence of sentences) {
    const sentenceLower = sentence.toLowerCase();
    
    // Проверяем, содержит ли предложение термин
    if (sentenceLower.includes(termLower)) {
      // Находим позицию термина в предложении
      const index = sentenceLower.indexOf(termLower);
      
      // Берем контекст: предложение целиком
      const context = sentence.trim();
      
      if (context.length > 0 && !contexts.some(c => c.context === context)) {
        contexts.push({
          context,
          source: 'text', // Можно добавить название источника
        });
        
        if (contexts.length >= maxContexts) break;
      }
    }
  }
  
  return contexts;
}

/**
 * Разбиение текста на предложения
 */
export function splitIntoSentences(text) {
  return text.split(/[.!?]+/).filter(s => s.trim().length > 0).map(s => s.trim());
}


